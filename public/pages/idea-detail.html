<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ›æ„è¯¦æƒ… - åˆ›æ„ä¸­å¿ƒ</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="../css/ideas.css">
    <style>
        .idea-detail-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px;
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.8) 0%, rgba(114, 9, 183, 0.3) 100%);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(0, 245, 255, 0.2);
            border-radius: 15px;
        }
        
        .idea-header-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .idea-section {
            margin-bottom: 30px;
        }
        
        .idea-section-title {
            color: #00f5ff;
            font-size: 1.2em;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0, 245, 255, 0.2);
        }
        
        .comment-form {
            margin-top: 20px;
        }
        
        .review-form {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .review-form-title {
            color: #00f5ff;
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-col {
            flex: 1;
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">AIåˆ›ä½œå¹³å°</div>
            </div>
            <div class="sidebar-menu">
                <a href="dashboard.html" class="menu-item">
                    <span class="menu-icon">ğŸ“Š</span>
                    <span class="menu-text">ä»ªè¡¨ç›˜</span>
                </a>
                <a href="projects.html" class="menu-item">
                    <span class="menu-icon">ğŸ“</span>
                    <span class="menu-text">é¡¹ç›®ç®¡ç†</span>
                </a>
                <a href="ideas.html" class="menu-item active">
                    <span class="menu-icon">ğŸ’¡</span>
                    <span class="menu-text">åˆ›æ„ä¸­å¿ƒ</span>
                </a>
                <!-- å…¶ä»–èœå•é¡¹ -->
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-container">
            <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
            <div class="top-bar">
                <div class="page-title">åˆ›æ„è¯¦æƒ…</div>
                <div class="user-info">
                    <span id="userRole" class="user-role">ç”¨æˆ·</span>
                    <span id="currentUsername" class="username">ç”¨æˆ·å</span>
                    <div class="avatar">ğŸ‘¤</div>
                </div>
            </div>

            <!-- ä¸»è¦å†…å®¹ -->
            <div class="main-content">
                <div class="content-header">
                    <div class="header-content">
                        <div>
                            <h1 class="content-title" id="ideaTitle">åˆ›æ„æ ‡é¢˜</h1>
                            <p class="content-subtitle">
                                <span id="ideaCategory" class="idea-detail-category">åˆ›æ„åˆ†ç±»</span>
                                <span id="ideaStatus" class="idea-detail-status status-pending">çŠ¶æ€</span>
                            </p>
                        </div>
                        <div class="header-actions">
                            <button class="action-btn secondary" onclick="window.location.href='ideas.html'">
                                <span>â†</span>è¿”å›åˆ›æ„ä¸­å¿ƒ
                            </button>
                        </div>
                    </div>
                </div>

                <div class="content-body">
                    <div class="idea-detail-container">
                        <div class="idea-header-actions" id="ideaActions">
                            <!-- åŠ¨æ€ç”Ÿæˆæ“ä½œæŒ‰é’® -->
                        </div>
                        
                        <div class="idea-section">
                            <div class="idea-meta">
                                <div class="idea-detail-author">
                                    <div class="author-avatar" id="authorAvatar">ğŸ‘¤</div>
                                    <span class="author-name" id="authorName">ä½œè€…</span>
                                </div>
                                <div class="idea-date" id="ideaDate">æäº¤æ—¶é—´</div>
                            </div>
                        </div>
                        
                        <div class="idea-section">
                            <h3 class="idea-section-title">åˆ›æ„æè¿°</h3>
                            <div class="idea-detail-description" id="ideaDescription">
                                <!-- åˆ›æ„æè¿°å†…å®¹ -->
                            </div>
                        </div>
                        
                        <div class="idea-section" id="ideaDetailsSection">
                            <h3 class="idea-section-title">è¯¦ç»†ä¿¡æ¯</h3>
                            <div class="idea-detail-section" id="scopeSection">
                                <h4>é€‚ç”¨èŒƒå›´</h4>
                                <p id="ideaScope">é€‚ç”¨èŒƒå›´å†…å®¹</p>
                            </div>
                            <div class="idea-detail-section" id="targetSection">
                                <h4>ç›®æ ‡å¯¹è±¡</h4>
                                <p id="ideaTarget">ç›®æ ‡å¯¹è±¡å†…å®¹</p>
                            </div>
                        </div>
                        
                        <div class="idea-section">
                            <h3 class="idea-section-title">ç»Ÿè®¡æ•°æ®</h3>
                            <div class="idea-detail-stats">
                                <div class="idea-detail-stat">
                                    <div class="stat-value" id="voteCount">0</div>
                                    <div class="stat-label">å¥½è¯„</div>
                                </div>
                                <div class="idea-detail-stat">
                                    <div class="stat-value" id="commentCount">0</div>
                                    <div class="stat-label">è¯„è®º</div>
                                </div>
                                <div class="idea-detail-stat" id="pointsStat">
                                    <div class="stat-value" id="pointsCount">0</div>
                                    <div class="stat-label">è·å¾—ç§¯åˆ†</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="idea-section" id="reviewFeedbackSection">
                            <h3 class="idea-section-title">å®¡æ ¸åé¦ˆ</h3>
                            <div class="review-feedback" id="reviewFeedback">
                                <!-- å®¡æ ¸åé¦ˆå†…å®¹ -->
                            </div>
                        </div>
                        
                        <div class="idea-section" id="reviewFormSection" style="display: none;">
                            <div class="review-form">
                                <h3 class="review-form-title">å®¡æ ¸åˆ›æ„</h3>
                                <form id="reviewForm" onsubmit="handleReviewIdea(event)">
                                    <input type="hidden" id="reviewIdeaId">
                                    
                                    <div class="form-group">
                                        <label for="reviewStatus" class="form-label">å®¡æ ¸ç»“æœ<span class="required-mark">*</span></label>
                                        <select id="reviewStatus" name="reviewStatus" class="form-input form-select" required>
                                            <option value="" disabled selected>è¯·é€‰æ‹©å®¡æ ¸ç»“æœ</option>
                                            <option value="approved">é‡‡çº³</option>
                                            <option value="rejected">ä¸é‡‡çº³</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="reviewFeedbackInput" class="form-label">å®¡æ ¸åé¦ˆ<span class="required-mark">*</span></label>
                                        <textarea id="reviewFeedbackInput" name="reviewFeedbackInput" class="form-input form-textarea" placeholder="è¯·è¾“å…¥å®¡æ ¸åé¦ˆæ„è§" required></textarea>
                                    </div>
                                    
                                    <div class="form-group" id="extraPointsGroup">
                                        <label for="extraPoints" class="form-label">é¢å¤–å¥–åŠ±ç§¯åˆ†</label>
                                        <input type="number" id="extraPoints" name="extraPoints" class="form-input" value="0" min="0">
                                        <div class="form-hint">åŸºç¡€ç§¯åˆ†ä¸º10åˆ†ï¼Œå¯æ ¹æ®åˆ›æ„è´¨é‡é¢å¤–å¥–åŠ±ç§¯åˆ†</div>
                                    </div>
                                    
                                    <div class="form-actions">
                                        <button type="button" class="idea-btn secondary" onclick="hideReviewForm()">å–æ¶ˆ</button>
                                        <button type="submit" class="idea-btn primary">æäº¤å®¡æ ¸</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <div class="idea-section">
                            <h3 class="idea-section-title">è¯„è®ºåŒº</h3>
                            
                            <div class="comment-form">
                                <textarea class="comment-input" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." id="commentInput"></textarea>
                                <button class="idea-btn primary" onclick="addComment()">æäº¤è¯„è®º</button>
                            </div>
                            
                            <div class="comment-list" id="commentList">
                                <!-- è¯„è®ºåˆ—è¡¨ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥å®¹å™¨ -->
    <div id="notificationContainer" class="notification-container"></div>

    <script src="../js/common.js"></script>
    <script>
        // é¡µé¢çŠ¶æ€ç®¡ç†
        const State = {
            user: null,
            idea: null,
            hasVoted: false
        };

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initPage();
        });

        // åˆå§‹åŒ–é¡µé¢
        async function initPage() {
            try {
                // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
                State.user = getCurrentUser();
                if (!State.user) {
                    window.location.href = '/';
                    return;
                }
                
                // æ›´æ–°ç”¨æˆ·ç•Œé¢
                updateUserInterface();
                
                // è·å–åˆ›æ„ID
                const ideaId = getIdeaIdFromUrl();
                if (!ideaId) {
                    showNotification('åˆ›æ„IDä¸å­˜åœ¨', 'error');
                    setTimeout(() => {
                        window.location.href = 'ideas.html';
                    }, 2000);
                    return;
                }
                
                // åŠ è½½åˆ›æ„æ•°æ®
                await loadIdeaDetails(ideaId);
                
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                showNotification('é¡µé¢åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•', 'error');
            }
        }

        // è·å–å½“å‰ç”¨æˆ·
        function getCurrentUser() {
            const userData = localStorage.getItem('userData') || localStorage.getItem('avaCreatorUser');
            return userData ? JSON.parse(userData) : null;
        }

        // æ›´æ–°ç”¨æˆ·ç•Œé¢
        function updateUserInterface() {
            const user = State.user;
            if (!user) return;

            // æ›´æ–°ç”¨æˆ·åæ˜¾ç¤º
            const usernameEl = document.getElementById('currentUsername');
            if (usernameEl) {
                usernameEl.textContent = user.username || user.nickname || 'ç”¨æˆ·';
            }

            // æ›´æ–°è§’è‰²æ˜¾ç¤º
            const roleEl = document.getElementById('userRole');
            if (roleEl) {
                const roleNames = {
                    'admin': 'ç®¡ç†å‘˜',
                    'investor': 'æŠ•èµ„è€…',
                    'product_manager': 'äº§å“ç»ç†',
                    'designer': 'è®¾è®¡å¸ˆ',
                    'developer': 'å¼€å‘è€…'
                };
                roleEl.textContent = roleNames[user.role] || 'ç”¨æˆ·';
            }
        }

        // ä»URLè·å–åˆ›æ„ID
        function getIdeaIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // åŠ è½½åˆ›æ„è¯¦æƒ…
        async function loadIdeaDetails(ideaId) {
            try {
                // æ¨¡æ‹ŸAPIè¯·æ±‚å»¶è¿Ÿ
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // æ¨¡æ‹Ÿè·å–åˆ›æ„è¯¦æƒ…
                const idea = getMockIdea(ideaId);
                
                if (!idea) {
                    showNotification('åˆ›æ„ä¸å­˜åœ¨', 'error');
                    setTimeout(() => {
                        window.location.href = 'ideas.html';
                    }, 2000);
                    return;
                }
                
                State.idea = idea;
                State.hasVoted = hasVoted(idea.id);
                
                // æ¸²æŸ“åˆ›æ„è¯¦æƒ…
                renderIdeaDetails();
                
            } catch (error) {
                console.error('åŠ è½½åˆ›æ„è¯¦æƒ…å¤±è´¥:', error);
                showNotification('åŠ è½½åˆ›æ„è¯¦æƒ…å¤±è´¥', 'error');
            }
        }

        // è·å–æ¨¡æ‹Ÿåˆ›æ„æ•°æ®
        function getMockIdea(ideaId) {
            // è¿™é‡Œåº”è¯¥æ˜¯ä»APIè·å–æ•°æ®ï¼Œç°åœ¨ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            const mockIdeas = [
                {
                    id: '1',
                    title: 'æ™ºèƒ½åˆ›æ„æ¨èç³»ç»Ÿ',
                    description: 'åŸºäºç”¨æˆ·å†å²è¡Œä¸ºå’Œåå¥½ï¼Œä½¿ç”¨AIç®—æ³•æ¨èä¸ªæ€§åŒ–åˆ›æ„å†…å®¹ï¼Œæé«˜ç”¨æˆ·å‚ä¸åº¦å’Œåˆ›æ„è´¨é‡ã€‚è¿™ä¸ªç³»ç»Ÿå¯ä»¥åˆ†æç”¨æˆ·è¿‡å»ç‚¹èµã€è¯„è®ºå’Œæµè§ˆçš„åˆ›æ„ç±»å‹ï¼Œç»“åˆç”¨æˆ·çš„è§’è‰²å’Œå…´è¶£æ ‡ç­¾ï¼Œæ¨èæœ€å¯èƒ½æ„Ÿå…´è¶£çš„åˆ›æ„å†…å®¹ã€‚åŒæ—¶ï¼Œç³»ç»Ÿè¿˜å¯ä»¥æ¨èç›¸ä¼¼ç”¨æˆ·å–œæ¬¢çš„åˆ›æ„ï¼Œæ‰©å±•ç”¨æˆ·çš„è§†é‡ã€‚',
                    category: 'technology',
                    status: 'approved',
                    createdAt: '2024-02-15',
                    author: {
                        id: '101',
                        name: 'å¼ ä¸‰',
                        avatar: 'ğŸ‘¨â€ğŸ’»'
                    },
                    votes: 24,
                    comments: [
                        {
                            id: '201',
                            author: {
                                id: '102',
                                name: 'æå››',
                                avatar: 'ğŸ‘©â€ğŸ¨'
                            },
                            content: 'è¿™ä¸ªåˆ›æ„éå¸¸æ£’ï¼æˆ‘ä»¬ç¡®å®éœ€è¦ä¸€ä¸ªæ›´æ™ºèƒ½çš„æ¨èç³»ç»Ÿã€‚',
                            createdAt: '2024-02-16T10:30:00Z'
                        },
                        {
                            id: '202',
                            author: {
                                id: '103',
                                name: 'ç‹äº”',
                                avatar: 'ğŸ‘¨â€ğŸ’¼'
                            },
                            content: 'å»ºè®®è€ƒè™‘åŠ å…¥ååŒè¿‡æ»¤ç®—æ³•ï¼Œå¯ä»¥æé«˜æ¨èå‡†ç¡®æ€§ã€‚',
                            createdAt: '2024-02-17T14:20:00Z'
                        }
                    ],
                    points: 30,
                    reviewFeedback: 'è¿™æ˜¯ä¸€ä¸ªéå¸¸æœ‰ä»·å€¼çš„åˆ›æ„ï¼Œå¯ä»¥æ˜¾è‘—æå‡å¹³å°ç”¨æˆ·ä½“éªŒã€‚å»ºè®®ä¼˜å…ˆå®æ–½ã€‚',
                    scope: 'å…¨å¹³å°',
                    target: 'æ‰€æœ‰ç”¨æˆ·'
                },
                {
                    id: '2',
                    title: 'åˆ›æ„åä½œç™½æ¿',
                    description: 'å®æ—¶å¤šäººåä½œçš„åœ¨çº¿ç™½æ¿å·¥å…·ï¼Œæ”¯æŒç»˜å›¾ã€æ€ç»´å¯¼å›¾ã€ä¾¿ç­¾ç­‰åŠŸèƒ½ï¼Œå¸®åŠ©å›¢é˜Ÿæ›´å¥½åœ°è¿›è¡Œåˆ›æ„å¤´è„‘é£æš´ã€‚',
                    category: 'product',
                    status: 'pending',
                    createdAt: '2024-02-20',
                    author: {
                        id: '102',
                        name: 'æå››',
                        avatar: 'ğŸ‘©â€ğŸ¨'
                    },
                    votes: 15,
                    comments: [],
                    points: 0,
                    scope: 'ç½‘é¡µåº”ç”¨',
                    target: 'è®¾è®¡å¸ˆã€äº§å“ç»ç†'
                }
            ];
            
            return mockIdeas.find(idea => idea.id === ideaId);
        }

        // æ¸²æŸ“åˆ›æ„è¯¦æƒ…
        function renderIdeaDetails() {
            const idea = State.idea;
            if (!idea) return;
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            document.title = `${idea.title} - åˆ›æ„ä¸­å¿ƒ`;
            
            // æ›´æ–°åˆ›æ„æ ‡é¢˜å’Œåˆ†ç±»
            document.getElementById('ideaTitle').textContent = idea.title;
            document.getElementById('ideaCategory').textContent = getCategoryName(idea.category);
            
            // æ›´æ–°åˆ›æ„çŠ¶æ€
            const statusEl = document.getElementById('ideaStatus');
            statusEl.textContent = getStatusName(idea.status);
            statusEl.className = `idea-detail-status status-${idea.status}`;
            
            // æ›´æ–°ä½œè€…ä¿¡æ¯
            document.getElementById('authorAvatar').textContent = idea.author.avatar;
            document.getElementById('authorName').textContent = idea.author.name;
            
            // æ›´æ–°æäº¤æ—¶é—´
            document.getElementById('ideaDate').textContent = `æäº¤äº ${formatDate(idea.createdAt)}`;
            
            // æ›´æ–°åˆ›æ„æè¿°
            document.getElementById('ideaDescription').textContent = idea.description;
            
            // æ›´æ–°è¯¦ç»†ä¿¡æ¯
            const scopeSection = document.getElementById('scopeSection');
            const targetSection = document.getElementById('targetSection');
            
            if (idea.scope) {
                document.getElementById('ideaScope').textContent = idea.scope;
                scopeSection.style.display = 'block';
            } else {
                scopeSection.style.display = 'none';
            }
            
            if (idea.target) {
                document.getElementById('ideaTarget').textContent = idea.target;
                targetSection.style.display = 'block';
            } else {
                targetSection.style.display = 'none';
            }
            
            if (!idea.scope && !idea.target) {
                document.getElementById('ideaDetailsSection').style.display = 'none';
            } else {
                document.getElementById('ideaDetailsSection').style.display = 'block';
            }
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            document.getElementById('voteCount').textContent = idea.votes;
            document.getElementById('commentCount').textContent = idea.comments ? idea.comments.length : 0;
            
            const pointsStat = document.getElementById('pointsStat');
            if (idea.status === 'approved') {
                document.getElementById('pointsCount').textContent = idea.points;
                pointsStat.style.display = 'block';
            } else {
                pointsStat.style.display = 'none';
            }
            
            // æ›´æ–°å®¡æ ¸åé¦ˆ
            const reviewFeedbackSection = document.getElementById('reviewFeedbackSection');
            const reviewFeedback = document.getElementById('reviewFeedback');
            
            if (idea.status !== 'pending' && idea.reviewFeedback) {
                reviewFeedback.className = `review-feedback ${idea.status}`;
                reviewFeedback.innerHTML = `
                    <h4>${idea.status === 'approved' ? 'å®¡æ ¸é€šè¿‡' : 'æœªè¢«é‡‡çº³'}</h4>
                    <p>${idea.reviewFeedback}</p>
                `;
                reviewFeedbackSection.style.display = 'block';
            } else {
                reviewFeedbackSection.style.display = 'none';
            }
            
            // æ›´æ–°æ“ä½œæŒ‰é’®
            renderActionButtons();
            
            // æ¸²æŸ“è¯„è®ºåˆ—è¡¨
            renderComments();
        }

        // æ¸²æŸ“æ“ä½œæŒ‰é’®
        function renderActionButtons() {
            const idea = State.idea;
            const actionsContainer = document.getElementById('ideaActions');
            
            if (!idea || !actionsContainer) return;
            
            let actionsHTML = '';
            
            // æŠ•ç¥¨æŒ‰é’®
            actionsHTML += `
                <button class="idea-btn vote ${State.hasVoted ? 'active' : ''}" onclick="voteIdea()">
                    <span>ğŸ‘</span> ${State.hasVoted ? 'å·²ç‚¹èµ' : 'ç‚¹èµ'}
                </button>
            `;
            
            // å®¡æ ¸æŒ‰é’®ï¼ˆä»…ç®¡ç†å‘˜å¯è§ä¸”åˆ›æ„çŠ¶æ€ä¸ºå¾…å®¡æ ¸ï¼‰
            if (idea.status === 'pending' && isAdmin()) {
                actionsHTML += `
                    <button class="idea-btn primary" onclick="showReviewForm()">
                        å®¡æ ¸åˆ›æ„
                    </button>
                `;
            }
            
            // ç¼–è¾‘æŒ‰é’®ï¼ˆä»…ä½œè€…å¯è§ä¸”åˆ›æ„çŠ¶æ€ä¸ºå¾…å®¡æ ¸ï¼‰
            if (idea.status === 'pending' && isCurrentUserAuthor()) {
                actionsHTML += `
                    <button class="idea-btn secondary" onclick="editIdea()">
                        ç¼–è¾‘åˆ›æ„
                    </button>
                `;
            }
            
            actionsContainer.innerHTML = actionsHTML;
        }

        // æ¸²æŸ“è¯„è®ºåˆ—è¡¨
        function renderComments() {
            const idea = State.idea;
            const commentList = document.getElementById('commentList');
            
            if (!idea || !commentList) return;
            
            if (!idea.comments || idea.comments.length === 0) {
                commentList.innerHTML = '<div class="empty-state"><p>æš‚æ— è¯„è®ºï¼Œæˆä¸ºç¬¬ä¸€ä¸ªè¯„è®ºè€…å§ï¼</p></div>';
                return;
            }
            
            const commentsHTML = idea.comments.map(comment => `
                <div class="comment-item">
                    <div class="comment-header">
                        <div class="comment-author">
                            <div class="author-avatar">${comment.author.avatar}</div>
                            <span class="author-name">${comment.author.name}</span>
                        </div>
                        <span class="comment-time">${formatRelativeTime(comment.createdAt)}</span>
                    </div>
                    <div class="comment-content">
                        ${comment.content}
                    </div>
                </div>
            `).join('');
            
            commentList.innerHTML = commentsHTML;
        }

        // æ˜¾ç¤ºå®¡æ ¸è¡¨å•
        function showReviewForm() {
            if (!isAdmin()) {
                showNotification('æ‚¨æ²¡æœ‰æƒé™å®¡æ ¸åˆ›æ„', 'error');
                return;
            }
            
            document.getElementById('reviewFormSection').style.display = 'block';
            document.getElementById('reviewIdeaId').value = State.idea.id;
            document.getElementById('reviewStatus').value = '';
            document.getElementById('reviewFeedbackInput').value = '';
            document.getElementById('extraPoints').value = 0;
            
            // æ»šåŠ¨åˆ°è¡¨å•ä½ç½®
            document.getElementById('reviewFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        // éšè—å®¡æ ¸è¡¨å•
        function hideReviewForm() {
            document.getElementById('reviewFormSection').style.display = 'none';
        }

        // å¤„ç†å®¡æ ¸åˆ›æ„
        function handleReviewIdea(event) {
            event.preventDefault();
            
            if (!isAdmin()) {
                showNotification('æ‚¨æ²¡æœ‰æƒé™å®¡æ ¸åˆ›æ„', 'error');
                return;
            }
            
            const status = document.getElementById('reviewStatus').value;
            const feedback = document.getElementById('reviewFeedbackInput').value;
            const extraPoints = parseInt(document.getElementById('extraPoints').value) || 0;
            
            // éªŒè¯è¡¨å•
            if (!status || !feedback) {
                showNotification('è¯·å¡«å†™å®Œæ•´çš„å®¡æ ¸ä¿¡æ¯', 'error');
                return;
            }
            
            // æ¨¡æ‹Ÿå®¡æ ¸å¤„ç†
            setTimeout(() => {
                // æ›´æ–°åˆ›æ„çŠ¶æ€
                State.idea.status = status;
                State.idea.reviewFeedback = feedback;
                
                // å¦‚æœé‡‡çº³ï¼Œè®¡ç®—ç§¯åˆ†
                if (status === 'approved') {
                    // åŸºç¡€ç§¯åˆ†10åˆ† + é¢å¤–å¥–åŠ±ç§¯åˆ†
                    State.idea.points = 10 + extraPoints;
                } else {
                    State.idea.points = 0;
                }
                
                // é‡æ–°æ¸²æŸ“åˆ›æ„è¯¦æƒ…
                renderIdeaDetails();
                
                // éšè—å®¡æ ¸è¡¨å•
                hideReviewForm();
                
                showNotification(`åˆ›æ„å®¡æ ¸å®Œæˆï¼ŒçŠ¶æ€å·²æ›´æ–°ä¸º"${getStatusName(status)}"`, 'success');
            }, 800);
        }

        // ä¸ºåˆ›æ„æŠ•ç¥¨
        function voteIdea() {
            if (!State.idea) return;
            
            // æ¨¡æ‹ŸæŠ•ç¥¨é€»è¾‘
            if (State.hasVoted) {
                // å–æ¶ˆæŠ•ç¥¨
                State.idea.votes--;
                State.hasVoted = false;
                showNotification('å·²å–æ¶ˆç‚¹èµ', 'info');
            } else {
                // æŠ•ç¥¨
                State.idea.votes++;
                State.hasVoted = true;
                
                // å¦‚æœåˆ›æ„å·²è¢«é‡‡çº³ï¼Œæ¯è·å¾—ä¸€ä¸ªå¥½è¯„é¢å¤–è·å¾—10ç§¯åˆ†
                if (State.idea.status === 'approved') {
                    State.idea.points += 10;
                }
                
                showNotification('ç‚¹èµæˆåŠŸ', 'success');
            }
            
            // æ›´æ–°æœ¬åœ°å­˜å‚¨ä¸­çš„æŠ•ç¥¨è®°å½•
            toggleVoteRecord(State.idea.id);
            
            // é‡æ–°æ¸²æŸ“åˆ›æ„è¯¦æƒ…
            renderIdeaDetails();
        }

        // æ·»åŠ è¯„è®º
        function addComment() {
            if (!State.idea) return;
            
            const commentInput = document.getElementById('commentInput');
            if (!commentInput || !commentInput.value.trim()) {
                showNotification('è¯·è¾“å…¥è¯„è®ºå†…å®¹', 'error');
                return;
            }
            
            // æ¨¡æ‹Ÿæ·»åŠ è¯„è®º
            const newComment = {
                id: Date.now().toString(),
                author: {
                    id: State.user.id || Date.now().toString(),
                    name: State.user.username || State.user.nickname || 'ç”¨æˆ·',
                    avatar: 'ğŸ‘¤'
                },
                content: commentInput.value.trim(),
                createdAt: new Date().toISOString()
            };
            
            // ç¡®ä¿commentsæ•°ç»„å­˜åœ¨
            if (!State.idea.comments) {
                State.idea.comments = [];
            }
            
            // æ·»åŠ æ–°è¯„è®º
            State.idea.comments.push(newComment);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            commentInput.value = '';
            
            // é‡æ–°æ¸²æŸ“è¯„è®ºåˆ—è¡¨
            renderComments();
            
            showNotification('è¯„è®ºå‘å¸ƒæˆåŠŸ', 'success');
        }

        // ç¼–è¾‘åˆ›æ„
        function editIdea() {
            if (!State.idea) return;
            
            // æ£€æŸ¥æƒé™
            if (!isCurrentUserAuthor() && !isAdmin()) {
                showNotification('æ‚¨æ²¡æœ‰æƒé™ç¼–è¾‘æ­¤åˆ›æ„', 'error');
                return;
            }
            
            // å¦‚æœåˆ›æ„å·²ç»è¢«å®¡æ ¸ï¼Œä¸å…è®¸ç¼–è¾‘
            if (State.idea.status !== 'pending') {
                showNotification('å·²å®¡æ ¸çš„åˆ›æ„ä¸èƒ½ç¼–è¾‘', 'error');
                return;
            }
            
            // è·³è½¬åˆ°ç¼–è¾‘é¡µé¢
            window.location.href = `idea-edit.html?id=${State.idea.id}`;
        }

        // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯ç®¡ç†å‘˜
        function isAdmin() {
            return State.user && State.user.role === 'admin';
        }

        // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯åˆ›æ„ä½œè€…
        function isCurrentUserAuthor() {
            return State.user && State.idea && State.idea.author && 
                   (State.user.id === State.idea.author.id || 
                    State.user.username === State.idea.author.name);
        }

        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»ä¸ºåˆ›æ„æŠ•ç¥¨
        function hasVoted(ideaId) {
            const votedIdeas = getVotedIdeas();
            return votedIdeas.includes(ideaId);
        }

        // åˆ‡æ¢æŠ•ç¥¨è®°å½•
        function toggleVoteRecord(ideaId) {
            const votedIdeas = getVotedIdeas();
            const index = votedIdeas.indexOf(ideaId);
            
            if (index === -1) {
                // æ·»åŠ æŠ•ç¥¨è®°å½•
                votedIdeas.push(ideaId);
            } else {
                // ç§»é™¤æŠ•ç¥¨è®°å½•
                votedIdeas.splice(index, 1);
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('votedIdeas', JSON.stringify(votedIdeas));
        }

        // è·å–ç”¨æˆ·å·²æŠ•ç¥¨çš„åˆ›æ„IDåˆ—è¡¨
        function getVotedIdeas() {
            const votedIdeasStr = localStorage.getItem('votedIdeas');
            return votedIdeasStr ? JSON.parse(votedIdeasStr) : [];
        }

        // è·å–åˆ†ç±»åç§°
        function getCategoryName(category) {
            const categoryNames = {
                'product': 'äº§å“åˆ›æ„',
                'technology': 'æŠ€æœ¯åˆ›æ„',
                'marketing': 'è¥é”€åˆ›æ„',
                'ux': 'ç”¨æˆ·ä½“éªŒ',
                'other': 'å…¶ä»–'
            };
            return categoryNames[category] || 'æœªåˆ†ç±»';
        }

        // è·å–çŠ¶æ€åç§°
        function getStatusName(status) {
            const statusNames = {
                'pending': 'å¾…å®¡æ ¸',
                'approved': 'å·²é‡‡çº³',
                'rejected': 'æœªé‡‡çº³'
            };
            return statusNames[status] || 'æœªçŸ¥çŠ¶æ€';
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }
        
        // æ ¼å¼åŒ–ç›¸å¯¹æ—¶é—´
        function formatRelativeTime(dateStr) {
            if (!dateStr) return '';
            
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);
            
            if (diffDay > 30) {
                return formatDate(dateStr);
            } else if (diffDay > 0) {
                return `${diffDay}å¤©å‰`;
            } else if (diffHour > 0) {
                return `${diffHour}å°æ—¶å‰`;
            } else if (diffMin > 0) {
                return `${diffMin}åˆ†é’Ÿå‰`;
            } else {
                return 'åˆšåˆš';
            }
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-icon">${getNotificationIcon(type)}</span>
                    <span class="notification-message">${message}</span>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">Ã—</button>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            const container = document.getElementById('notificationContainer');
            container.appendChild(notification);
            
            // è‡ªåŠ¨å…³é—­
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('fade-out');
                    setTimeout(() => notification.remove(), 500);
                }
            }, 5000);
        }
        
        // è·å–é€šçŸ¥å›¾æ ‡
        function getNotificationIcon(type) {
            const icons = {
                'success': 'âœ…',
                'error': 'âŒ',
                'info': 'â„¹ï¸'
            };
            return icons[type] || 'â„¹ï¸';
        }
    </script>
